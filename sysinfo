#!/bin/bash
# Run this from macOS Recovery (Utilities > Terminal).
# It will:
#  1) Count internal, physical disks.
#     - If exactly 1, erase it APFS named "Macintosh HD".
#     - If 2 or more, assume a Fusion pair and run diskutil resetFusion (auto-confirm "Yes").
#  2) Show system information (with optional QR output).
#  3) Run /Volumes/MDS/1561oem_nocheck.sh

set -e

log(){ /bin/echo "[$(/bin/date '+%F %T')] $*"; }



# ===================== System Information block =====================
/bin/echo "***************************************************"
/bin/echo "* System Information                              *"
/bin/echo "***************************************************"

case "$0" in
  /*) script_path="$0" ;;
  *)  script_path="$PWD/$0" ;;
esac
dir="$(/usr/bin/dirname "$script_path")"

model_id=$(sysctl hw.model | sed "s/.*: \(.*\)/\1/g")
cpu=$(sysctl machdep.cpu.brand_string | sed "s/.*: \(.*\)/\1/g" | sed "s/Intel.*(TM) //g" | sed "s/ CPU @ /-/g" | tr ',' '.')
hardware_memory=$(($(sysctl -n hw.memsize)/1024/1024/1024))
first_physical_disk_size=$(diskutil list physical | awk '/GUID_partition_scheme/ {print $0; exit}' | sed "s/.*GUID_partition_scheme[^0-9]\{1,\}\([0-9]\{1,\}\)\.[0-9]\{1,\} \([A-Za-z]\{1,\}\).*/\1 \2/")
serial=$(ioreg -rd1 -c IOPlatformExpertDevice | awk -F'"' '/IOPlatformSerialNumber/{print $4}')

qrcode_info="$serial"

QR="/tmp/qrencode"
if [ ! -x "$QR" ]; then
  curl -Ls -o "$QR" "https://raw.githubusercontent.com/alfonsomri/mac-scripts/refs/heads/main/qrencode"
  chmod +x "$QR"
fi
if [ -x "$QR" ]; then
  echo "Scan QR for machine-readable: \"${qrcode_info}\""
  echo "${qrcode_info}" | "$QR" -t ANSI256UTF8 -m 1
else
  echo "WARNING: qrencode not found; skipping QR code output." >&2
fi

/bin/echo "Model Identifier: ${model_id}"
/bin/echo "Disk Size: ${first_physical_disk_size}"
/bin/echo "CPU: ${cpu}"
/bin/echo "RAM: ${hardware_memory}"
/bin/echo "Serial Number: ${serial}"
/bin/echo "Current Boot Environment: $(sw_vers -productVersion)"
/bin/echo "***************************************************"
/bin/echo
/bin/echo
# =================== End System Information block ===================

